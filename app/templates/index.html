{% extends 'base.html' %}

{% block title %}Finns of Change Index Page{% endblock %}

{% block content %}
<!-- Dashboard com informações -->
<div class="bg-white dark:bg-gray-900 shadow rounded-lg p-6 relative" style="margin-bottom: 20px;">
    
    <!-- Dropdown -->
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-5xl font-bold text-gray-900 dark:text-white text-center">Statistics Overview</h2> 
        
        <div class="z-10"> 
            <button id="dropdownDefaultButton" data-dropdown-toggle="dropdown" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
                {% if standard_population == 0 %}
                    All Populations
                {% else %}
                    {{ standard_population }} - {{ population_name }}
                {% endif %}
                <svg class="w-2.5 h-2.5 ms-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                </svg>
            </button>

            <div id="dropdown" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44 dark:bg-gray-700">
                <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
                    <li>
                        <a href="{{ url_for('api.index', population='all') }}" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white {% if selected_population == 'all' %}bg-gray-100 dark:bg-gray-600{% endif %}">All Populations</a>
                    </li>
                    {% for population in all_populations_data %}
                    <li>
                        <a href="{{ url_for('api.index', population=population.id) }}" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white {% if population.name|string == selected_population %}bg-gray-100 dark:bg-gray-600{% endif %}">{{ population.id }} - {{ population.name }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 "> 
    
        <div class="grid w-full grid-cols-1 gap-2">

            <div class="text-center dark:bg-gray-800 rounded-lg py-3"> 
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Total Populations</h3>
                <p class="mt-2 text-8xl font-bold text-blue-600 dark:text-blue-400">{{ total_populations }}</p>
            </div>

            <div class="text-center dark:bg-gray-800 rounded-lg py-4 h-30">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Color Distribution</h3>
                <canvas id="colorChart" class="w-full h-auto" width="100" height="100"></canvas>
            </div>

        </div>

        <div class="grid w-full grid-cols-1 gap-6">

            <div class="text-center dark:bg-gray-800 rounded-lg py-3">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Total Fishes</h3>
                <p class="mt-2 text-8xl font-bold text-blue-600 dark:text-blue-400">{{ total_fishes }}</p>
            </div>

            <div class="text-center dark:bg-gray-800 rounded-lg py-3">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Average Swimming Speed</h3>
                <p class="mt-2 text-8xl font-bold text-blue-600 dark:text-blue-400">{{ avg_speed }} m/s</p>
            </div>
        </div>

        <div class="grid w-full grid-cols-1 gap-6"> 

            <div class="text-center dark:bg-gray-800 rounded-lg py-4"> 
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Male / Female Ratio</h3>
                <canvas id="sexRatioChart" class="w-full h-auto" width="250" height="250"></canvas>
            </div>

            <div class="text-center dark:bg-gray-800 rounded-lg py-3">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Generations</h3>
                <p class="mt-2 text-8xl font-bold text-blue-600 dark:text-blue-400">{{ generations }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabela com os indivíduos -->
<div class="bg-white dark:bg-gray-900 shadow rounded-lg p-8 relative" style="margin-top: 20px;">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-5xl font-bold text-gray-900 dark:text-white text-center">Fishes List</h2>
    </div>
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg mt-6">
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">
                        ID
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Generation
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Gender
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Timestamp
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Population ID
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Population Name
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Father ID
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Mother ID
                    </th>
                    {# <th scope="col" class="px-6 py-3">
                        <span class="sr-only">Actions</span>
                    </th> #}
                </tr>
            </thead>
            <tbody>
                {% for individual in individuals %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        {{ individual.id }}
                    </th>
                    <td class="px-6 py-4">
                        {{ individual.generation }}
                    </td>
                    <td class="px-6 py-4">
                        {{ individual.gender }}
                    </td>
                    <td class="px-6 py-4">
                        {{ individual.timestamp }}
                    </td>
                    <td class="px-6 py-4">
                        {{ individual.population_id }}
                    </td>
                    <td class="px-6 py-4">
                        {{ individual.population_name }}
                    </td>
                    <td class="px-6 py-4">
                        {{ individual.father_id if individual.father_id is not none else '-' }} {# Exibe '-' se não houver pai #}
                    </td>
                    <td class="px-6 py-4">
                        {{ individual.mother_id if individual.mother_id is not none else '-' }} {# Exibe '-' se não houver mãe #}
                    </td>
                    {# Exemplo de coluna de ação #}
                    {# <td class="px-6 py-4 text-right">
                        <a href="{{ url_for('api.individual_details', id=individual.id) }}" class="font-medium text-blue-600 dark:text-blue-500 hover:underline">View</a>
                    </td> #}
                </tr>
                {% else %}
                {# Mensagem caso não haja indivíduos para a população selecionada #}
                <tr class="bg-white dark:bg-gray-800">
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                        No individuals found for this population.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Gráfico de Cores
    const colorCtx = document.getElementById('colorChart').getContext('2d');
    new Chart(colorCtx, {
        type: 'pie',
        data: {
            labels: {{ color_data.keys() | list | tojson }},
            datasets: [{
                data: {{ color_data.values() | list | tojson }},
                backgroundColor: {{ color_data.keys() | list | tojson }},
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks:{
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + ' ocorrências';
                            }
                            return label;
                        }
                    }
                },
                borderColor: '#ffffff',
                borderWidth: 2
            }
        }
    });

    // Gráfico Machos/Fêmeas
    const sexCtx = document.getElementById('sexRatioChart').getContext('2d');
    new Chart(sexCtx, {
        type: 'doughnut',
        data: {
            labels: ['Machos', 'Fêmeas'],
            datasets: [{
                data: [{{ sex_data['male'] }}, {{ sex_data['female'] }}],
                backgroundColor: ['#60a5fa', '#f472b6'],
                hoverOffset: 4
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
</script>
{% endblock %}